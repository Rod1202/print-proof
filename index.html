<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Impresoras (Supabase)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos CSS existentes */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
        }
        
        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-input {
            width: 250px;
        }
        
        .user-icon {
            font-size: 1.5rem;
            color: #6c757d;
        }
        
        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .form-control, .form-select {
            font-size: 0.9rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #0066ff;
            box-shadow: 0 0 0 0.2rem rgba(0, 102, 255, 0.25);
        }
        
        /* Estados con colores específicos */
        .estado-produccion { background-color: #28a745 !important; }
        .estado-backup { background-color: #007bff !important; }
        .estado-reportado { background-color: #ffc107 !important; color: #000 !important; }
        .estado-cambiado { background-color: #fd7e14 !important; }
        .estado-taller { background-color: #dc3545 !important; }
        .estado-almacenado { background-color: #6c757d !important; }
        
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            border-color: #0066ff;
            background-color: rgba(0, 102, 255, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: #0066ff;
            background-color: rgba(0, 102, 255, 0.1);
        }
        
        .file-list {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .btn-action {
            min-width: 120px;
            font-weight: 600;
        }
        
        .search-results {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .result-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .file-link {
            color: #0066ff;
            text-decoration: none;
        }
        
        .file-link:hover {
            text-decoration: underline;
        }

        /* Estilos para el mensaje de notificación */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: #fff;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none; 
        }

        .message-box.show {
            opacity: 1;
            display: block; 
        }

        .logo-img {
            max-width: 120px; 
            max-height: 80px; 
            width: auto;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <div class="logo-text"><img src="logo.png" alt="Logo" class="logo-img"></div>
            <div class="search-container">
                <div class="input-group">
                    <input type="text" class="form-control search-input" id="searchInput" placeholder="Buscar">
                    <button class="btn btn-outline-secondary" type="button" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="user-icon">
                <i class="fas fa-user-circle"></i>
                <span id="userIdDisplay"></span> <!-- Para mostrar el ID de usuario -->
            </div>
        </div>
        
        <!-- Formulario Principal -->
        <form id="printerForm">
            <!-- Información de Cliente -->
            <div class="form-section">
                <div class="section-title">Información de Cliente</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">CLIENTE</label>
                        <input type="text" class="form-control" id="cliente" name="cliente">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">CONTACTO</label>
                        <input type="text" class="form-control" id="contacto" name="contacto">
                    </div>
                    <div class="col-12">
                        <label class="form-label">DIRECCIÓN</label>
                        <input type="text" class="form-control" id="direccion" name="direccion">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">SEDE</label>
                        <input type="text" class="form-control" id="sede" name="sede">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">EMPRESA</label>
                        <input type="text" class="form-control" id="empresa" name="empresa">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">DPTO.</label>
                        <input type="text" class="form-control" id="dpto" name="dpto">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">PROVINCIA</label>
                        <input type="text" class="form-control" id="provincia" name="provincia">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">DISTRITO</label>
                        <input type="text" class="form-control" id="distrito" name="distrito">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ZONA</label>
                        <input type="text" class="form-control" id="zona" name="zona">
                    </div>
                </div>
            </div>
            
            <!-- Información de Impresora -->
            <div class="form-section">
                <div class="section-title">Información de Impresora</div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">MODELO DE IMPRESORA</label>
                        <input type="text" class="form-control" id="modelo" name="modelo">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">SERIE</label>
                        <input type="text" class="form-control" id="serie" name="serie" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ESTADO</label>
                        <select class="form-select" id="estado" name="estado">
                            <option value="">Seleccionar estado</option>
                            <option value="produccion">Producción</option>
                            <option value="backup">Backup</option>
                            <option value="reportado">Reportado</option>
                            <option value="cambiado">Cambiado</option>
                            <option value="taller">En Taller</option>
                            <option value="almacenado">Almacenado</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">OBSERVACIONES</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Área de Archivos -->
            <div class="form-section">
                <div class="section-title">Archivos</div>
                <div class="file-upload-area" id="fileUploadArea">
                    <i class="fas fa-paperclip fa-2x mb-2 text-muted"></i>
                    <div>Haz clic aquí o arrastra archivos para subir</div>
                    <small class="text-muted">PDF, DOC, IMG - Máximo 10MB por archivo</small>
                    <input type="file" id="fileInput" style="display: none;" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt">
                </div>
                <div class="file-list" id="fileList"></div>
                <!-- Botón de cámara para capturar foto -->
                <div class="d-flex justify-content-center mt-2">
                    <button type="button" class="btn btn-outline-secondary" id="cameraButton">
                        <i class="fas fa-camera"></i> Tomar Foto
                    </button>
                    <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display: none;">
                </div>
                <!-- Fin botón de cámara -->
            </div>
            
            <!-- Botones de Acción -->
            <div class="d-flex justify-content-center gap-3 mt-4">
                <button type="submit" class="btn btn-success btn-action">
                    <i class="fas fa-save me-2"></i>Guardar Registro
                </button>
                <button type="button" class="btn btn-primary btn-action" id="editButton">
                    <i class="fas fa-edit me-2"></i>Editar Registro
                </button>
            </div>
        </form>
        
        <!-- Resultados de Búsqueda -->
        <div id="searchResults"></div>
    </div>

    <!-- Contenedor para mensajes de notificación -->
    <div id="messageBox" class="message-box"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // === PRINTER MANAGEMENT APPLICATION MODULE ===
        // This module encapsulates all the application logic,
        // making it more organized and maintainable.
        const PrinterApp = (function() {
            // --- Supabase Configuration ---
            // !! IMPORTANTE !!
            // Reemplaza 'YOUR_SUPABASE_URL' y 'YOUR_SUPABASE_ANON_KEY' con las credenciales reales de tu proyecto Supabase.
            // Las encontrarás en tu consola de Supabase: Project Settings -> API.
            const SUPABASE_URL = 'https://pvnggaleugsmqokcbugd.supabase.co'; // Ejemplo: 'https://your-project-id.supabase.co'
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2bmdnYWxldWdzbXFva2NidWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzODk3MTksImV4cCI6MjA2NTk2NTcxOX0.p3csZRJkUWy4kEkpkG3q-MF1-b7UudHRRbfQb5epbS4'; // Ejemplo: 'eyJhbGciOiJIUzI1NiI...'
            const SUPABASE_BUCKET_NAME = 'printer-documents'; // Nombre de tu bucket de Supabase Storage (asegúrate de que exista y tenga políticas configuradas)

            let supabase;
            let userId = null;
            let isAuthReady = false;

            // --- Elementos del DOM (inicializados en la función init) ---
            let printerForm;
            let fileInput;
            let fileUploadArea;
            let fileList;
            let messageBox;
            let estadoSelect;
            let searchInput;
            let searchButton;
            let editButton;
            let saveButton;
            let userIdDisplay;

            // --- Variables de Estado de la Aplicación ---
            let uploadedFiles = []; // Almacena objetos File para subir, o metadatos de archivos ya subidos
            let editMode = false;
            let currentEditId = null; // ID del registro de impresora en la BD (UUID de Supabase)

            /**
             * Inicializa el cliente Supabase y configura el listener de autenticación.
             * Maneja el registro/inicio de sesión de usuarios anónimos para el piloto.
             */
            async function initSupabase() {
                try {
                    if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                        throw new Error("Supabase URL o Anon Key no configuradas. Por favor, actualiza el código.");
                    }
                    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } catch (error) {
                    console.error("Error al inicializar Supabase:", error.message);
                    showMessage("Error de configuración de Supabase: " + error.message + ". Por favor, asegúrate de reemplazar 'YOUR_SUPABASE_URL' y 'YOUR_SUPABASE_ANON_KEY' con tus credenciales reales.", 8000);
                    // No se puede continuar sin Supabase correctamente inicializado
                    return; 
                }

                // Intenta iniciar sesión con el usuario anónimo existente o crear uno nuevo
                try {
                    let currentEmail = localStorage.getItem('supabase_anon_email');
                    let currentPassword = localStorage.getItem('supabase_anon_password');

                    if (!currentEmail || !currentPassword) {
                        currentEmail = `anon-${crypto.randomUUID()}@example.com`;
                        currentPassword = crypto.randomUUID();
                        localStorage.setItem('supabase_anon_email', currentEmail);
                        localStorage.setItem('supabase_anon_password', currentPassword);
                    }
                    
                    // Intenta hacer signIn primero, si no existe el usuario, lo registra
                    const { error: signInError } = await supabase.auth.signInWithPassword({
                        email: currentEmail,
                        password: currentPassword,
                    });

                    if (signInError) {
                        if (signInError.message.includes('AuthApiError: Invalid login credentials')) {
                            // Si las credenciales son inválidas (porque el usuario no existe), intenta registrarlo
                            const { error: signUpError } = await supabase.auth.signUp({
                                email: currentEmail,
                                password: currentPassword,
                            });
                            if (signUpError) throw signUpError;
                        } else {
                            // En caso de otro error de inicio de sesión, limpiar localStorage y reintentar
                            console.warn("Error de inicio de sesión inesperado, limpiando credenciales anónimas y reintentando:", signInError.message);
                            localStorage.removeItem('supabase_anon_email');
                            localStorage.removeItem('supabase_anon_password');
                            // Para reintentar, podríamos llamar a initSupabase() de nuevo o forzar un re-load.
                            // Por ahora, simplemente mostrar el error y dejar que el onAuthStateChange maneje si hay una sesión válida.
                            throw signInError; 
                        }
                    }

                    // Después de intentar signIn o signUp, la sesión será manejada por onAuthStateChange.
                    // No intentamos obtener la sesión inmediatamente aquí, ya que el listener se encargará.
                    // Esto evita la condición de carrera donde getSession() podría fallar si la sesión
                    // aún no está completamente establecida en el cliente después de la operación de auth.

                } catch (authError) {
                    showMessage('Error en la autenticación anónima: ' + authError.message, 5000);
                    console.error('Error Supabase Auth:', authError);
                    userIdDisplay.innerText = `Error Auth`;
                }

                // Este listener se mantiene para futuras actualizaciones de sesión (ej. token refresh)
                // Es el punto principal para que `userId` e `isAuthReady` se actualicen.
                supabase.auth.onAuthStateChange((event, session) => {
                    if (session && session.user) {
                        userId = session.user.id;
                        userIdDisplay.innerText = `ID: ${userId}`;
                    } else {
                        userId = null;
                        userIdDisplay.innerText = `No Autenticado`;
                    }
                    isAuthReady = true; // Asegurarse de que el estado esté actualizado una vez que el listener haya procesado la sesión.
                });
            }

            /**
             * Muestra un mensaje temporal al usuario.
             * @param {string} message - El mensaje a mostrar.
             * @param {number} duration - Duración en milisegundos que el mensaje estará visible.
             */
            function showMessage(message, duration = 3000) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            }

            /**
             * Formatea el tamaño de un archivo para mostrarlo de forma legible.
             * @param {number} bytes - Tamaño del archivo en bytes.
             * @returns {string} Tamaño formateado (ej. "1.2 MB").
             */
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            /**
             * Actualiza el estilo del campo de selección de estado.
             */
            function updateEstadoStyle() {
                const value = estadoSelect.value;
                estadoSelect.classList.remove('estado-produccion', 'estado-backup', 'estado-reportado', 
                                                'estado-cambiado', 'estado-taller', 'estado-almacenado');
                if (value) {
                    estadoSelect.classList.add(`estado-${value}`);
                    estadoSelect.style.color = value === 'reportado' ? '#000' : '#fff';
                    estadoSelect.style.fontWeight = 'bold';
                } else {
                    estadoSelect.style.color = '';
                    estadoSelect.style.fontWeight = '';
                }
            }

            /**
             * Actualiza la lista de archivos mostrados en el frontend.
             * Los archivos ahora son objetos de metadatos de la tabla `printer_files`.
             */
            function updateFileList() {
                fileList.innerHTML = '';
                uploadedFiles.forEach((fileObj, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    // Si el archivo ya tiene una downloadURL, significa que ya está en Storage y se puede descargar
                    const fileLink = fileObj.downloadURL ? `<a href="${fileObj.downloadURL}" target="_blank" class="file-link">${fileObj.name}</a>` : fileObj.name;
                    
                    fileItem.innerHTML = `
                        <span><i class="fas fa-file me-2"></i>${fileLink} (${formatFileSize(fileObj.size)})</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });

                fileList.querySelectorAll('.btn-outline-danger').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = e.currentTarget.dataset.index;
                        removeFile(index); 
                    });
                });
            }

            /**
             * Elimina un archivo de la lista de archivos cargados.
             * Esto solo lo elimina del array temporal `uploadedFiles`, no de Supabase Storage/DB.
             * La eliminación de Storage y DB se haría en una función separada o al guardar.
             * @param {number} index - Índice del archivo a eliminar.
             */
            function removeFile(index) { 
                uploadedFiles.splice(index, 1);
                updateFileList();
            }

            /**
             * Añade archivos a la lista de archivos cargados temporalmente.
             * @param {File[]} files - Array de objetos File.
             */
            function addFiles(files) {
                files.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {
                        showMessage(`El archivo ${file.name} excede el tamaño máximo de 10MB`, 4000);
                        return;
                    }
                    uploadedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        file: file // El objeto File real, se usará para subirlo a Storage
                    });
                });
                updateFileList();
            }

            /**
             * Limpia el formulario y reinicia el estado de edición.
             */
            function resetForm() {
                printerForm.reset();
                uploadedFiles = []; 
                updateFileList();
                updateEstadoStyle();
                editMode = false;
                currentEditId = null;
                saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Registro';
                document.getElementById('searchResults').innerHTML = ''; 
            }

            // --- Manejadores de Eventos del DOM ---

            // Drag and drop para archivos
            function handleDragOver(e) {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            }

            function handleDragLeave(e) {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                addFiles(files);
            }

            function handleFileSelect(e) {
                const files = Array.from(e.target.files);
                addFiles(files);
            }

            /**
             * Maneja el envío del formulario (guardar o actualizar registros de impresoras).
             * Se encarga de guardar el registro principal y sus archivos asociados.
             */
            async function handleSubmit(e) {
                e.preventDefault();
                
                if (!isAuthReady || !userId) {
                    showMessage('La autenticación de Supabase no está lista. Espera un momento o recarga la página.', 3000);
                    return;
                }

                const formData = new FormData(printerForm);
                const serie = formData.get('serie');
                
                if (!serie) {
                    showMessage('El número de serie es obligatorio', 3000);
                    return;
                }

                // Datos del registro de impresora para la tabla `printers`
                const printerData = {
                    cliente: formData.get('cliente') || '',
                    contacto: formData.get('contacto') || '',
                    direccion: formData.get('direccion') || '',
                    sede: formData.get('sede') || '',
                    empresa: formData.get('empresa') || '',
                    dpto: formData.get('dpto') || '',
                    provincia: formData.get('provincia') || '',
                    distrito: formData.get('distrito') || '',
                    zona: formData.get('zona') || '',
                    modelo: formData.get('modelo') || '',
                    serie: serie,
                    estado: formData.get('estado') || '',
                    observaciones: formData.get('observaciones') || '',
                    user_id: userId, 
                };

                try {
                    let printerRecordId;

                    if (editMode && currentEditId) {
                        // Modo edición: Actualizar el registro existente en la tabla `printers`
                        const { error: updateError } = await supabase
                            .from('printers')
                            .update(printerData)
                            .eq('id', currentEditId)
                            .eq('user_id', userId); 
                        
                        if (updateError) throw updateError;
                        printerRecordId = currentEditId;
                        
                    } else {
                        // Modo nuevo registro: Insertar en `printers` y obtener el ID generado
                        const { data, error } = await supabase
                            .from('printers')
                            .insert(printerData)
                            .select('id'); 

                        if (error) throw error;
                        printerRecordId = data[0].id; 
                    }

                    // --- Manejo de Archivos ---
                    // Obtener los metadatos de los archivos que ya estaban asociados a esta impresora en la DB
                    const { data: existingFileRecords, error: fetchFilesError } = await supabase
                        .from('printer_files')
                        .select('id, file_name, storage_path, download_url')
                        .eq('printer_id', printerRecordId)
                        .eq('user_id', userId);

                    if (fetchFilesError) throw fetchFilesError;

                    const filesToDelete = existingFileRecords.filter(oldFile => 
                        // Un archivo antiguo se elimina si no está en la lista de `uploadedFiles` actual
                        // (comparando por nombre y si no es un nuevo File con el mismo nombre)
                        !uploadedFiles.some(newFile => 
                            newFile.name === oldFile.file_name && (newFile.file || newFile.downloadURL === oldFile.download_url)
                        )
                    );

                    // Eliminar archivos de Storage y sus metadatos de `printer_files`
                    for (const fileToDelete of filesToDelete) {
                        // Eliminar del Storage
                        const { error: deleteStorageError } = await supabase.storage
                            .from(SUPABASE_BUCKET_NAME)
                            .remove([fileToDelete.storage_path]);
                        if (deleteStorageError) console.warn("Error al eliminar archivo de Storage:", deleteStorageError.message);

                        // Eliminar de la tabla `printer_files`
                        const { error: deleteDbError } = await supabase
                            .from('printer_files')
                            .delete()
                            .eq('id', fileToDelete.id)
                            .eq('user_id', userId);
                        if (deleteDbError) console.error("Error al eliminar metadatos del archivo de DB:", deleteDbError.message);
                    }

                    // Subir nuevos archivos e insertar/actualizar metadatos en `printer_files`
                    for (const fileObj of uploadedFiles) {
                        if (fileObj.file) { // Si fileObj.file existe, es un nuevo archivo que necesita ser subido
                            const filePath = `${userId}/${printerRecordId}/${fileObj.name}`; // Ruta única en Storage
                            const { error: storageError } = await supabase.storage
                                .from(SUPABASE_BUCKET_NAME) 
                                .upload(filePath, fileObj.file, {
                                    cacheControl: '3600', 
                                    upsert: true // Sobrescribe si el archivo ya existe con ese nombre/ruta
                                });

                            if (storageError) throw storageError;

                            const { data: publicUrlData } = supabase.storage
                                .from(SUPABASE_BUCKET_NAME)
                                .getPublicUrl(filePath);

                            const fileMetadata = {
                                printer_id: printerRecordId,
                                file_name: fileObj.name,
                                file_size: fileObj.size,
                                file_type: fileObj.type,
                                storage_path: filePath,
                                download_url: publicUrlData.publicUrl,
                                user_id: userId
                            };

                            // Comprobar si ya existe un registro de archivo con esta printer_id y nombre_de_archivo
                            const { data: existingFileEntry, error: checkFileError } = await supabase
                                .from('printer_files')
                                .select('id')
                                .eq('printer_id', printerRecordId)
                                .eq('file_name', fileObj.name)
                                .single();

                            if (checkFileError && checkFileError.code !== 'PGRST116') { // PGRST116 means "no rows found"
                                throw checkFileError;
                            }

                            if (existingFileEntry) {
                                // Si existe, actualizar
                                const { error: updateFileMetaError } = await supabase
                                    .from('printer_files')
                                    .update(fileMetadata)
                                    .eq('id', existingFileEntry.id)
                                    .eq('user_id', userId);
                                if (updateFileMetaError) throw updateFileMetaError;
                            } else {
                                // Si no existe, insertar
                                const { error: insertFileMetaError } = await supabase
                                    .from('printer_files')
                                    .insert(fileMetadata);
                                if (insertFileMetaError) throw insertFileMetaError;
                            }
                        }
                    }

                    showMessage(editMode ? 'Registro actualizado exitosamente en Supabase!' : 'Registro guardado exitosamente en Supabase!', 3000);
                    
                    resetForm(); 

                } catch (error) {
                    showMessage('Error al guardar/actualizar el registro: ' + error.message, 5000);
                    console.error("Error al guardar el registro en Supabase:", error);
                }
            }

            /**
             * Busca registros de impresoras en Supabase y sus archivos asociados.
             */
            async function searchRecord() { 
                if (!isAuthReady || !userId) {
                    showMessage('La autenticación de Supabase no está lista. Espera un momento o recarga la página.', 3000);
                    return;
                }

                const searchTerm = searchInput.value.trim();
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = ''; 
                
                if (!searchTerm) {
                    return;
                }

                try {
                    // Buscar impresoras por serie, cliente o modelo
                    const { data: printers, error: printerError } = await supabase
                        .from('printers')
                        .select('*')
                        .or(`serie.ilike.%${searchTerm}%,cliente.ilike.%${searchTerm}%,modelo.ilike.%${searchTerm}%`)
                        .eq('user_id', userId); 

                    if (printerError) throw printerError;

                    if (!printers || printers.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="search-results">
                                <h5>Resultados de búsqueda</h5>
                                <p class="text-muted">No se encontraron registros que coincidan con: "${searchTerm}"</p>
                            </div>
                        `;
                        return;
                    }

                    let resultsHtml = `
                        <div class="search-results">
                            <h5>Resultados de búsqueda (${printers.length})</h5>
                    `;

                    for (const record of printers) { 
                        const estadoClass = record.estado ? `estado-${record.estado}` : '';
                        const estadoText = record.estado ? record.estado.charAt(0).toUpperCase() + record.estado.slice(1) : 'Sin estado';
                        
                        let filesHtml = '';
                        // Obtener archivos asociados a esta impresora desde la tabla `printer_files`
                        const { data: recordFiles, error: filesError } = await supabase
                            .from('printer_files')
                            .select('file_name, download_url')
                            .eq('printer_id', record.id)
                            .eq('user_id', userId); 

                        if (filesError) {
                            console.error("Error al obtener archivos para impresora:", filesError.message);
                            filesHtml = `<div class="mt-2 text-danger">Error al cargar archivos.</div>`;
                        } else if (recordFiles && recordFiles.length > 0) {
                            filesHtml = `
                                <div class="mt-2">
                                    <strong>Archivos:</strong><br>
                                    ${recordFiles.map(file => `
                                        <a href="${file.download_url}" target="_blank" class="file-link d-block">
                                            <i class="fas fa-file me-1"></i>${file.file_name}
                                        </a>
                                    `).join('')}
                                </div>
                            `;
                        }

                        resultsHtml += `
                            <div class="result-item">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Cliente:</strong> ${record.cliente || 'N/A'}<br>
                                        <strong>Serie:</strong> ${record.serie}<br>
                                        <strong>Modelo:</strong> ${record.modelo || 'N/A'}<br>
                                        <strong>Contacto:</strong> ${record.contacto || 'N/A'}<br>
                                        <strong>Dirección:</strong> ${record.direccion || 'N/A'}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Empresa:</strong> ${record.empresa || 'N/A'}<br>
                                        <strong>Sede:</strong> ${record.sede || 'N/A'}<br>
                                        <strong>Estado:</strong> <span class="badge ${estadoClass}">${estadoText}</span><br>
                                        <strong>Observaciones:</strong> ${record.observaciones || 'N/A'}<br>
                                        <strong>Última actualización:</strong> ${new Date(record.updated_at || record.created_at).toLocaleString()}
                                    </div>
                                </div>
                                ${filesHtml}
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary load-for-edit-btn" data-record-id="${record.id}">
                                        <i class="fas fa-edit me-1"></i>Cargar para Editar
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    resultsHtml += '</div>';
                    resultsContainer.innerHTML = resultsHtml;

                    document.querySelectorAll('.load-for-edit-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const recordId = e.currentTarget.dataset.recordId;
                            loadForEdit(recordId); 
                        });
                    });

                } catch (error) {
                    showMessage('Error al buscar registros: ' + error.message, 5000);
                    console.error("Error al buscar registros en Supabase:", error);
                }
            }

            /**
             * Carga un registro de impresora y sus archivos en el formulario para su edición.
             * @param {string} recordId - ID del registro de impresora a cargar.
             */
            async function loadForEdit(recordId) { 
                if (!isAuthReady || !userId) {
                    showMessage('La autenticación de Supabase no está lista. Espera un momento o recarga la página.', 3000);
                    return;
                }

                try {
                    // Cargar los datos principales de la impresora
                    const { data: record, error: printerError } = await supabase
                        .from('printers')
                        .select('*')
                        .eq('id', recordId)
                        .eq('user_id', userId) 
                        .single();

                    if (printerError) throw printerError;
                    if (!record) { 
                        showMessage('Registro no encontrado para edición o no tienes permisos.', 3000);
                        return;
                    }

                    // Cargar los archivos asociados a esta impresora
                    const { data: recordFiles, error: filesError } = await supabase
                        .from('printer_files')
                        .select('file_name, file_size, file_type, storage_path, download_url')
                        .eq('printer_id', recordId)
                        .eq('user_id', userId);

                    if (filesError) throw filesError;

                    // Llenar el formulario con los datos del registro
                    document.getElementById('cliente').value = record.cliente || '';
                    document.getElementById('contacto').value = record.contacto || '';
                    document.getElementById('direccion').value = record.direccion || '';
                    document.getElementById('sede').value = record.sede || '';
                    document.getElementById('empresa').value = record.empresa || '';
                    document.getElementById('dpto').value = record.dpto || '';
                    document.getElementById('provincia').value = record.provincia || '';
                    document.getElementById('distrito').value = record.distrito || '';
                    document.getElementById('zona').value = record.zona || '';
                    document.getElementById('modelo').value = record.modelo || '';
                    document.getElementById('serie').value = record.serie || '';
                    estadoSelect.value = record.estado || '';
                    document.getElementById('observaciones').value = record.observaciones || '';

                    updateEstadoStyle();

                    // Cargar los archivos existentes del registro para mostrarlos
                    // Los archivos de `recordFiles` ya son metadata, no objetos File reales.
                    uploadedFiles = recordFiles || []; 
                    updateFileList(); 

                    editMode = true;
                    currentEditId = recordId;
                    saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Actualizar Registro';

                    printerForm.scrollIntoView({behavior: 'smooth'});

                } catch (error) {
                    showMessage('Error al cargar registro para edición: ' + error.message, 5000);
                    console.error("Error al cargar registro para edición en Supabase:", error);
                }
            }

            /**
             * Busca un registro de impresora por su número de serie y lo carga para edición.
             */
            async function editRecordBySerie() {
                if (!isAuthReady || !userId) {
                    showMessage('La autenticación de Supabase no está lista. Espera un momento o recarga la página.', 3000);
                    return;
                }
                const serie = document.getElementById('serie').value.trim();
                if (!serie) {
                    showMessage('Ingresa un número de serie para buscar y editar.', 3000);
                    return;
                }

                try {
                    const { data: records, error } = await supabase
                        .from('printers')
                        .select('id')
                        .eq('serie', serie)
                        .eq('user_id', userId); 

                    if (error) throw error;

                    if (records && records.length > 0) {
                        loadForEdit(records[0].id); 
                        showMessage('Registro encontrado y cargado para edición.', 3000);
                    } else {
                        showMessage('No se encontró un registro con esa serie para editar o no tienes permisos.', 3000);
                    }
                } catch (error) {
                    showMessage('Error al buscar registro para edición: ' + error.message, 5000);
                    console.error("Error al buscar registro para edición en Supabase:", error);
                }
            }

            /**
             * Inicializa las referencias a los elementos del DOM y los listeners de eventos.
             */
            function init() {
                // Obtener referencias a elementos del DOM
                printerForm = document.getElementById('printerForm');
                fileInput = document.getElementById('fileInput');
                fileUploadArea = document.getElementById('fileUploadArea');
                fileList = document.getElementById('fileList');
                messageBox = document.getElementById('messageBox');
                estadoSelect = document.getElementById('estado');
                searchInput = document.getElementById('searchInput');
                searchButton = document.getElementById('searchButton');
                editButton = document.getElementById('editButton');
                saveButton = printerForm.querySelector('.btn-success');
                userIdDisplay = document.getElementById('userIdDisplay');

                // Asignar event listeners
                fileUploadArea.addEventListener('dragover', handleDragOver);
                fileUploadArea.addEventListener('dragleave', handleDragLeave);
                fileUploadArea.addEventListener('drop', handleDrop);
                fileUploadArea.addEventListener('click', () => fileInput.click()); 
                fileInput.addEventListener('change', handleFileSelect);
                estadoSelect.addEventListener('change', updateEstadoStyle);
                printerForm.addEventListener('submit', handleSubmit); 
                searchButton.addEventListener('click', searchRecord);
                editButton.addEventListener('click', editRecordBySerie); 
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchRecord();
                    }
                });

                // Botón de cámara para capturar foto
                const cameraButton = document.getElementById('cameraButton');
                const cameraInput = document.getElementById('cameraInput');
                cameraButton.addEventListener('click', () => cameraInput.click());
                cameraInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });

                updateEstadoStyle();
                initSupabase(); // Inicializar Supabase después de que el DOM esté listo
            }

            // Métodos públicos expuestos por el módulo
            return {
                init: init
            };
        })();

        // Inicializar la aplicación cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', PrinterApp.init);
    </script>
</body>
</html>
